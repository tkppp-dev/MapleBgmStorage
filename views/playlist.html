<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% include "container/bootstrap&axios.html" %}
    <link href="./css/player.css" rel="stylesheet">
    <link href="./css/upscroll.css" rel="stylesheet">
    <title>{{title}}</title>
    <style>
        @media (max-width : 991px) {
            .play-list-item {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                height: 48px;
                font-size: 15px;
            }
        }

        .playlist-item-component {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 24px;
            font-size: 15px;
        }

        .playlist-item-category {
            color: gray;
            padding-top: 1px"

        }

        .list-btn {
            width: 20px;
            height: 20px;
        }

        .unactive-list {
            background-color: lightgrey;
        }

        #list-popular {
            text-align: center;
            border-right: 1px solid lightgrey;
        }

        #list-recent {
            text-align: center;
        }
    </style>
</head>

<body>
    {% include "container/nav.html" %}
    <div class="container-fluid">
        <div class="row">
            {% include "container/player.html" %}
            <div id="main" class="col">
                {% if user and user.id %}
                <div id="my-playlist" class="row">
                    <strong class="my-2" style="font-size: 18px;">내 재생목록</strong>
                    <hr style="margin-bottom : 6px">
                    {% for list in myPlaylist %}
                    <div>
                        <div class="playlist-title my-1 border-bottom px-1 pb-1">
                            <div class="row">
                                <div class="col" data-bs-toggle="collapse" href="#myList-{{loop.index}}" role="button">
                                    <span style="font-size: 16px;">{{list.name}}</span>
                                    <img class="list-btn" src="./images/expand-more.png">
                                </div>
                                <div class="row me-1 px-0 col-auto">
                                    <div class="col-auto px-1" role="button" onclick="playBgm(null,'{{list.id}}')">
                                        <img class="list-btn" src="./images/play-playlist.png">
                                    </div>
                                    <div class="col-auto px-1" role="button"
                                        onclick="refreshMyList('{{list.id}}', '{{loop.index}}')">
                                        <img class="list-btn" src="./images/refresh.png">
                                    </div>
                                    <div class="col-auto px-1" onclick="deleteList('{{list.id}}')" role="button">
                                        <img class="list-btn" src="./images/delete-btn.png">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="myList-{{loop.index}}" class="collapse">
                            {% set listLoopIdx = loop.index %}
                            {% for item in list.PlayListItems %}
                            <div class="row border-bottom py-1 mx-1">
                                <div class="col row play-list-item" onclick="playBgm('{{item.Bgm.id}}','{{list.id}}')"
                                    role="button">
                                    <div class="col-lg-6 col-md-12 playlist-item-component" style="font-size: 15px;">
                                        {{ item.Bgm.name }}
                                    </div>
                                    <div class="col-lg-6 col-md-12 playlist-item-component playlist-item-category">
                                        {{ item.Bgm.category1 }} > {{ item.Bgm.category2}}
                                        {% if item.Bgm.category3 %} > {{ item.Bgm.category3 }}{% endif %}
                                    </div>
                                </div>
                                <div class="row col-auto">
                                    <div class="bgmId-{{item.Bgm.id}} add-playlist col-auto px-1" role="button"
                                        data-bs-toggle="modal" data-bs-target="#listSelectModal">
                                        <img class="list-btn" src="./images/add-playlist.png">
                                    </div>
                                    <div class="col-auto px-1" onclick="deleteListItem('{{list.id}}','{{item.id}}', '{{listLoopIdx}}')"
                                        role="button">
                                        <img class="list-btn" src="./images/delete-btn.png">
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor%}
                </div>
                <div class="mb-4"></div>
                {% endif %}
                <div id="list-selector" class="row mb-1 border-top border-bottom">
                    <div id="list-popular" class="col py-1" role="button">
                        <strong class="my-2" style="font-size: 18px;">인기 재생목록</strong>
                    </div>
                    <div id="list-recent" class="unactive-list col py-1" role="button">
                        <strong class="my-2" style="font-size: 18px;">최신 재생목록</strong>
                    </div>
                </div>
                <div id="list-popular-body" class="row">
                    {% for list in popularPlaylist %}
                    <div>
                        <div class="playlist-title my-1 border-bottom px-1 pb-1">
                            <div class="row">
                                <div class="col" data-bs-toggle="collapse" href="#popularList-{{loop.index}}"
                                    role="button">
                                    <span class="mx-1">{{loop.index}}</span>
                                    <span style="font-size: 16px;">{{list.name}}</span>
                                    <img class="list-btn" src="./images/expand-more.png">
                                </div>
                                <div class="row me-1 px-0 col-auto">
                                    <div class="col-auto px-1">
                                        <img class="list-id-{{list.id}} like-btn-popular list-btn" role="button"
                                            onclick="changeLike('{{list.id}}')" src="./images/unlike-star.png">
                                    </div>
                                    <div class="bgmId-{{item.Bgm.id}} col-auto px-1" role="button"
                                        onclick="playBgm(null,'{{list.id}}')">
                                        <img class="list-btn" src="./images/play-playlist.png">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="popularList-{{loop.index}}" class="collapse">
                            {% for item in list.PlayListItems %}
                            <div class="row border-bottom py-1 mx-1">
                                <div class="col row play-list-item" onclick="playBgm('{{item.Bgm.id}}','{{list.id}}')"
                                    role="button">
                                    <div class="col-lg-6 col-md-12 playlist-item-component" style="font-size: 15px;">
                                        {{ item.Bgm.name }}
                                    </div>
                                    <div class="col-lg-6 col-md-12 playlist-item-component playlist-item-category">
                                        {{ item.Bgm.category1 }} > {{ item.Bgm.category2}}
                                        {% if item.Bgm.category3 %} > {{ item.Bgm.category3 }}{% endif %}
                                    </div>
                                </div>
                                <div class="row col-auto">
                                    <div class="bgmId-{{item.Bgm.id}} add-playlist col-auto px-1" role="button"
                                        data-bs-toggle="modal" data-bs-target="#listSelectModal">
                                        <img class="list-btn" src="./images/add-playlist.png">
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor%}
                </div>
                <div id="list-recent-body" class="row d-none">
                    {% for list in recentPlaylist %}
                    <div>
                        <div class="playlist-title my-1 border-bottom px-1 pb-1">
                            <div class="row">
                                <div class="col" data-bs-toggle="collapse" href="#recentList-{{loop.index}}"
                                    role="button">
                                    <span style="font-size: 16px;">{{list.name}}</span>
                                    <img class="list-btn" src="./images/expand-more.png">
                                </div>
                                <div class="row me-1 px-0 col-auto">
                                    <div class="col-auto px-1">
                                        <img class="list-id-{{list.id}} like-btn-recent list-btn" role="button"
                                            onclick="changeLike('{{list.id}}')" src="./images/unlike-star.png">
                                    </div>
                                    <div class="col-auto px-1" role="button" onclick="playBgm(null,'{{list.id}}')">
                                        <img class="list-btn" src="./images/play-playlist.png">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="recentList-{{loop.index}}" class="collapse">
                            {% for item in list.PlayListItems %}
                            <div class="row border-bottom py-1 mx-1">
                                <div class="col row play-list-item" onclick="playBgm('{{item.Bgm.id}}','{{list.id}}')"
                                    role="button">
                                    <div class="col-lg-6 col-md-12 playlist-item-component" style="font-size: 15px;">
                                        {{ item.Bgm.name }}
                                    </div>
                                    <div class="col-lg-6 col-md-12 playlist-item-component playlist-item-category">
                                        {{ item.Bgm.category1 }} > {{ item.Bgm.category2}}
                                        {% if item.Bgm.category3 %} > {{ item.Bgm.category3 }}{% endif %}
                                    </div>
                                </div>
                                <div class="row col-auto">
                                    <div class="bgmId-{{item.Bgm.id}} add-playlist col-auto px-1" role="button"
                                        data-bs-toggle="modal" data-bs-target="#listSelectModal">
                                        <img class="list-btn" src="./images/add-playlist.png">
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor%}
                </div>
                <div class="row justify-content-center">
                    <span role="button" class="col-auto border border-2 border-dark rounded py-1 my-2"
                        onclick="addNextList()">더보기</span>
                </div>
            </div>
        </div>
        <div id="bottom-blank">
        </div>
    </div>
    {% include "container/addPlaylist.html" %}
    {% include "container/upscroll-btn.html" %}
    <script src="./js/nav.js"></script>
    <script src="./js/player.js"></script>
    <script>
        window.onload = async function () {
            const popularBtn = document.getElementById('list-popular')
            const recentBtn = document.getElementById('list-recent')
            const popularBody = document.getElementById('list-popular-body')
            const recentBody = document.getElementById('list-recent-body')
            const deleteListBtn = document.getElementById('delete-playlist')

            popularBtn.addEventListener('click', () => {
                if (nowOpenList == 'recent') {
                    popularBtn.classList.remove('unactive-list')
                    recentBtn.classList.add('unactive-list')
                    popularBody.classList.remove('d-none')
                    recentBody.classList.add('d-none')
                    nowOpenList = 'popular'
                }
            })
            recentBtn.addEventListener('click', () => {
                if (nowOpenList == 'popular') {
                    recentBtn.classList.remove('unactive-list')
                    popularBtn.classList.add('unactive-list')
                    recentBody.classList.remove('d-none')
                    popularBody.classList.add('d-none')
                    nowOpenList = 'recent'
                }
            })

            await setListLike(0, 'popular')
            await setListLike(0, 'recent')
        }

        let nowOpenList = 'popular'
        let popularListOffset = 1
        let recentListOffset = 1

        async function refreshMyList(listId, mylistId) {
            try {
                const res = await axios.get('/playlist/mylist', {
                    params: {
                        listId
                    }
                })

                if (res.data.success) {
                    const refreshNode = document.getElementById(`myList-${mylistId}`)
                    let body = ''
                    for (let item of res.data.listBgmArr) {
                        body += `<div class="row border-bottom py-1 mx-1">
                                <div class="col row play-list-item" onclick="playBgm('${item.Bgm.id}','${item.list_id}')"
                                    role="button">
                                    <div class="col-lg-6 col-md-12 playlist-item-component" style="font-size: 15px;">
                                        ${ item.Bgm.name }
                                    </div>
                                    <div class="col-lg-6 col-md-12 playlist-item-component playlist-item-category">
                                        ${ item.Bgm.category1 } > ${ item.Bgm.category2}
                                        ${ item.Bgm.category3 != undefined ? '> '+ item.Bgm.category3 : '' }
                                    </div>
                                </div>
                                <div class="row col-auto">
                                    <div class="bgmId-${item.Bgm.id} add-playlist col-auto px-1" role="button"
                                        data-bs-toggle="modal" data-bs-target="#listSelectModal">
                                        <img class="list-btn" src="./images/add-playlist.png">
                                    </div>
                                    <div class="col-auto px-1" onclick="deleteListItem('${item.list_id}','${item.id}', '${mylistId}')"
                                        role="button">
                                        <img class="list-btn" src="./images/delete-btn.png">
                                    </div>
                                </div>
                            </div>`
                    }
                    refreshNode.innerHTML = body
                }
            } catch (err) {
                console.error(err)
            }
        }

        async function setListLike(offset, type) {
            const likeBtn = document.getElementsByClassName(`like-btn-${type}`)

            const res = await axios.get('playlist/like', {
                params: {
                    offset,
                    type
                }
            })
            if (res.data.isLogin) {
                for (let i = offset * 10; i < likeBtn.length; i++) {
                    if (res.data.likeList[i - offset * 10].isLike) {
                        likeBtn[i].src = './images/like-star.png'
                        likeBtn[i].classList.add('like')
                    } else {
                        likeBtn[i].classList.add('unlike')
                    }
                }
            } else {
                for (let i = offset * 10; i < likeBtn.length; i++) {
                    likeBtn[i].classList.add('unlike')
                }
            }
        }

        async function changeLike(listId) {
            const el = event.target
            const list = document.getElementsByClassName(`list-id-${listId}`)
            const idx = el.classList.length - 1
            if (el.classList[idx] === 'like') {
                const res = await axios.delete('/playlist/like', {
                    params: {
                        listId
                    }
                })
                if (res.data.success) {
                    for (let v of list) {
                        v.src = './images/unlike-star.png'
                        v.classList.remove('like')
                        v.classList.add('unlike')
                    }
                }
            } else if (el.classList[idx] === 'unlike') {
                const res = await axios.post('/playlist/like', {
                    listId
                })
                if (!res.data.isLogin) {
                    alert('로그인이 필요한 서비스입니다')
                } else if (res.data.success) {
                    for (let v of list) {
                        v.src = './images/like-star.png'
                        v.classList.remove('unlike')
                        v.classList.add('like')
                    }
                } else {
                    alert(res.data.message)
                }
            }
        }

        async function deleteList(listId) {
            const agree = confirm('해당 재생목록을 삭제하시겠습니까?')
            if (agree) {
                const res = await axios.delete('/playlist', {
                    params: {
                        id: listId
                    }
                })
                if (res.data.success) {
                    alert(res.data.message)
                    location.reload()
                } else {
                    alert(res.data.message)
                }
            }
        }

        async function deleteListItem(listId, itemId, loopIdx) {
            const agree = confirm('해당 곡을 재생목록에서 삭제하시겠습니까?')
            if (agree) {
                const res = await axios.delete('/playlist/item', {
                    params: {
                        listId: listId,
                        itemId: itemId,
                    }
                })
                if (res.data.success) {
                    alert(res.data.message)
                    refreshMyList(listId, loopIdx)
                } else {
                    alert(res.data.message)
                }
            }
        }

        async function addNextList() {
            const offset = nowOpenList == 'popular' ? popularListOffset : recentListOffset
            const listType = nowOpenList == 'popular' ? 'popular' : 'recent'

            const res = await axios.get('/playlist/nextList', {
                params: {
                    offset,
                    listType
                }
            })
            if (res.data.success) {
                const html = makeNextListHtml(res.data.list, listType, offset)
                const listNode = document.getElementById(`list-${listType}-body`)
                let temp = listNode.innerHTML + html
                listNode.innerHTML = temp
                setListLike(offset, listType)
                if (listType == 'popular') {
                    popularListOffset += 1
                } else {
                    recentListOffset += 1
                }
            } else {
                alert(res.data.message)
            }
        }

        function makeNextListHtml(listData, listType, offset) {
            let innerHtml = ''

            for (let i = 0; i < listData.length; i++) {
                innerHtml += `<div>
                            <div class="playlist-title my-1 border-bottom px-1 pb-1">
                                <div class="row">
                                    <div class="col" data-bs-toggle="collapse" href="#${listType}List-${i + offset*10 + 1}"
                                        role="button">
                                        ${listType == 'popular' ? `<span class="mx-1">${i + offset*10 + 1}</span>` : ''}
                                        <span style="font-size: 16px;">${listData[i].name}</span>
                                        <img class="list-btn" src="./images/expand-more.png">
                                    </div>
                                    <div class="row me-1 px-0 col-auto">
                                        <div class="col-auto px-1">
                                            <img class="list-id-${listData[i].id} like-btn-${listType} list-btn"
                                                role="button" onclick="changeLike('${listData[i].id}')"
                                                src="./images/unlike-star.png">
                                        </div>
                                        <div class="col-auto px-1" role="button" onclick="playBgm(null,'${listData[i].id}')">
                                            <img class="list-btn" src="./images/play-playlist.png">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="${listType}List-${i + offset*10}" class="collapse">`
                for (let item of listData[i].PlayListItems) {
                    innerHtml += `
                            <div class="row border-bottom py-1 mx-1">
                                <div class="col row play-list-item" onclick="playBgm('${item.Bgm.id}','${listData[i].id}')"
                                    role="button">
                                    <div class="col-lg-6 col-md-12 playlist-item-component" style="font-size: 15px;">
                                        ${ item.Bgm.name }
                                    </div>
                                    <div class="col-lg-6 col-md-12 playlist-item-component playlist-item-category">
                                        ${ item.Bgm.category1 } > ${ item.Bgm.category2}
                                        ${ item.Bgm.category3 != undefined ? '> '+ item.Bgm.category3 : '' }
                                    </div>
                                </div>
                                <div class="row col-auto">
                                    <div class="add-playlist col-auto px-1" role="button" data-bs-toggle="modal"
                                        data-bs-target="#listSelectModal">
                                        <img class="list-btn" src="./images/add-playlist.png">
                                    </div>
                                </div>
                            </div>`
                }
                innerHtml += '</div></div>'
            }
            return innerHtml
        }
    </script>
</body>

</html>